"use strict";(self.webpackChunkhackfi_training=self.webpackChunkhackfi_training||[]).push([[386],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),p=c(n),m=r,h=p["".concat(l,".").concat(m)]||p[m]||d[m]||i;return n?a.createElement(h,s(s({ref:t},u),{},{components:n})):a.createElement(h,s({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=p;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,s[1]=o;for(var c=2;c<i;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},4162:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var a=n(7462),r=(n(7294),n(3905));const i={sidebar_position:2,title:"The Smart Contract Lifecycle",hide_title:!0},s=void 0,o={unversionedId:"Smart-Contracts/smart-contract-lifecycle",id:"Smart-Contracts/smart-contract-lifecycle",title:"The Smart Contract Lifecycle",description:"Smart Contract Lifecycle \ud83c\udf34\ud83d\udeb2",source:"@site/docs/Smart-Contracts/smart-contract-lifecycle.md",sourceDirName:"Smart-Contracts",slug:"/Smart-Contracts/smart-contract-lifecycle",permalink:"/multiversity/Smart-Contracts/smart-contract-lifecycle",draft:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,title:"The Smart Contract Lifecycle",hide_title:!0},sidebar:"tutorialSidebar",previous:{title:"ToC",permalink:"/multiversity/Smart-Contracts/day-2-toc"},next:{title:"Solidity",permalink:"/multiversity/smart-contracts/solidity-101"}},l={},c=[{value:"Smart Contract Lifecycle \ud83c\udf34\ud83d\udeb2",id:"smart-contract-lifecycle-",level:2},{value:"Design Patterns",id:"design-patterns",level:2},{value:"Behavioral patterns",id:"behavioral-patterns",level:3},{value:"Security patterns",id:"security-patterns",level:3},{value:"Upgradeability patterns",id:"upgradeability-patterns",level:3},{value:"Behavioral Patterns",id:"behavioral-patterns-1",level:2},{value:"Guard Check",id:"guard-check",level:3},{value:"State Machine",id:"state-machine",level:3},{value:"Oracle",id:"oracle",level:3},{value:"Randomness",id:"randomness",level:3},{value:"Flaws",id:"flaws",level:4},{value:"Workarounds",id:"workarounds",level:4},{value:"Security patterns",id:"security-patterns-1",level:2},{value:"Access Restriction",id:"access-restriction",level:3},{value:"Checks Effects Interactions",id:"checks-effects-interactions",level:3},{value:"Secure Ether Transfer",id:"secure-ether-transfer",level:3},{value:"Pull over Push:",id:"pull-over-push",level:3},{value:"Problem",id:"problem",level:4},{value:"Possible Solution",id:"possible-solution",level:4},{value:"Emergency Stop",id:"emergency-stop",level:3},{value:"Upgradeability Patterns",id:"upgradeability-patterns-1",level:2},{value:"Proxy Delegate:",id:"proxy-delegate",level:3},{value:"Eternal Storage",id:"eternal-storage",level:3},{value:"Memory Array Building",id:"memory-array-building",level:2},{value:"References",id:"references",level:2}],u={toc:c};function d(e){let{components:t,...i}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"smart-contract-lifecycle-"},"Smart Contract Lifecycle \ud83c\udf34\ud83d\udeb2"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Life Cycle of Smart Contract Development",src:n(2526).Z,width:"1374",height:"589"})),(0,r.kt)("h2",{id:"design-patterns"},"Design Patterns"),(0,r.kt)("admonition",{title:"DESIGN PATTERN",type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Design patterns are reusable, conventional solutions used to solve reoccurring design flaws.")),(0,r.kt)("h3",{id:"behavioral-patterns"},"Behavioral patterns"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#guard-check"},"Guard check")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#state-machine"},"State machine")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#oracle"},"Oracle")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#randomness"},"Randomness"))),(0,r.kt)("h3",{id:"security-patterns"},"Security patterns"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#access-restriction"},"Access restriction")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#checks-effects-interactions"},"Checks Effects Interactions")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#secure-ether-transfer"},"Secure Ether transfer")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#pull-over-push"},"Pull-over-push")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#emergency-stop"},"Emergency stop"))),(0,r.kt)("h3",{id:"upgradeability-patterns"},"Upgradeability patterns"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#proxy-delegate"},"Proxy delegate")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#eternal-storage"},"Eternal storage")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#memory-array-building"},"Memory array building"))),(0,r.kt)("h2",{id:"behavioral-patterns-1"},"Behavioral Patterns"),(0,r.kt)("h3",{id:"guard-check"},"Guard Check"),(0,r.kt)("admonition",{title:"Intent",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Ensure that the behavior of a smart contract and its input parameters are as expected.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},'contract Contribution {\n  function contribute (address _from) payable public {\n    //NOTE: requires msg.value to be not 0.\n    require(msg.value != 0);\n\n    //NOTE: requires that the sender or _from address be not 0.\n    require(_from != address(0));\n\n    unit prevBalance = this.balance;\n    unit amount;\n\n    if(_from.balance == 0) {\n      amount = msg.value;\n    } \n    else if (_from.balance < msg.sender.balance) {\n      amount = msg.value / 2;\n    } \n    else {\n    //NOTE: revert throws an exception\n      revert("Insufficent Balance!!!");\n    }\n\n    _from.transfer(amount);\n\n    //assert \n    assert(this.balance == prevBalance - amount);\n  }\n}\n')),(0,r.kt)("p",null,"Solidity uses ",(0,r.kt)("inlineCode",{parentName:"p"},"state-reverting")," exceptions to handle errors. These exceptions undo all the changes made to the state in the current function call and sub-calls and flags an error to the caller."),(0,r.kt)("p",null,"Some exceptions in a sub-call are rethrown automatically unless they are caught in a ",(0,r.kt)("inlineCode",{parentName:"p"},"try/catch")," statement.\nExceptions to this rule are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"send")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"call")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"delegatecall")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"staticcall"))),(0,r.kt)("p",null,"The above functions return ",(0,r.kt)("inlineCode",{parentName:"p"},"false")," as their first return value in case of exception instead of throwing an error."),(0,r.kt)("admonition",{title:"revert",type:"info"},(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},"A direct revert can be triggered using the ",(0,r.kt)("inlineCode",{parentName:"li"},"revert")," statement and the ",(0,r.kt)("inlineCode",{parentName:"li"},"revert")," function."),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"revert")," statement takes a custom error as direct argument without parentheses: ",(0,r.kt)("inlineCode",{parentName:"li"},"revert CustomError(arg1, arg2)")),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"revert()")," function, which uses parentheses and accepts a string: ",(0,r.kt)("inlineCode",{parentName:"li"},"revert();")," or ",(0,r.kt)("inlineCode",{parentName:"li"},'revert("description");')))),(0,r.kt)("admonition",{title:"assert",type:"info"},(0,r.kt)("p",{parentName:"admonition"},(0,r.kt)("inlineCode",{parentName:"p"},"assert()")," :"),(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},"evaluates the conditions for a function"),(0,r.kt)("li",{parentName:"ul"},"throws an exception, reverts the contract to previous state"),(0,r.kt)("li",{parentName:"ul"},"consumes the gas supply if the requirements fail after execution"),(0,r.kt)("li",{parentName:"ul"},"assert should only be used to test for internal errors and to check invariants"))),(0,r.kt)("admonition",{title:"require",type:"info"},(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"require()")," is used to declare the conditions under which a function executes."),(0,r.kt)("li",{parentName:"ul"},"It takes a condition as an argument and throws an exception if the condition evaluates to ",(0,r.kt)("inlineCode",{parentName:"li"},"false")),(0,r.kt)("li",{parentName:"ul"},"It terminates the function's execution in case of ",(0,r.kt)("inlineCode",{parentName:"li"},"false")," without burning any gas."),(0,r.kt)("li",{parentName:"ul"},"It is currently not possible to use custom errors in combination with require"))),(0,r.kt)("h3",{id:"state-machine"},"State Machine"),(0,r.kt)("admonition",{title:"Intent",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Enable a contract to go through different stages with different corresponding functionality exposed.")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The state machine pattern simulates the behavior of a system based on its previous and current inputs. "),(0,r.kt)("li",{parentName:"ul"},"This pattern is used to breakdown larger problems into simple stages, which are later used to control the execution flow.")),(0,r.kt)("p",null,"This sample contract showcases the state machine for a blind auction and is inspired by the example code provided in the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.soliditylang.org/en/v0.4.21/common-patterns.html#state-machine"},"Solidity documentation"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},"// This code has not been professionally audited, therefore I cannot make any promises about\n// safety or correctness. Use at own risk.\ncontract StateMachine {\n    \n    enum Stages {\n        AcceptingBlindBids,\n        RevealBids,\n        WinnerDetermined,\n        Finished\n    }\n\n    Stages public stage = Stages.AcceptingBlindBids;\n\n    uint public creationTime = now;\n\n    modifier atStage(Stages _stage) {\n        require(stage == _stage);\n        _;\n    }\n    \n    modifier transitionAfter() {\n        _;\n        nextStage();\n    }\n    \n    modifier timedTransitions() {\n        if (stage == Stages.AcceptingBlindBids && now >= creationTime + 6 days) {\n            nextStage();\n        }\n        if (stage == Stages.RevealBids && now >= creationTime + 10 days) {\n            nextStage();\n        }\n        _;\n    }\n\n    function bid() public payable timedTransitions atStage(Stages.AcceptingBlindBids) {\n        // Implement biding here\n    }\n\n    function reveal() public timedTransitions atStage(Stages.RevealBids) {\n        // Implement reveal of bids here\n    }\n\n    function claimGoods() public timedTransitions atStage(Stages.WinnerDetermined) transitionAfter {\n        // Implement handling of goods here\n    }\n\n    function cleanup() public atStage(Stages.Finished) {\n        // Implement cleanup of auction here\n    }\n    \n    function nextStage() internal {\n        stage = Stages(uint(stage) + 1);\n    }\n}\n")),(0,r.kt)("p",null,"If the current state of the contract is not ",(0,r.kt)("inlineCode",{parentName:"p"},"AcceptingDeposit"),", users can not deposit to the contract, and if the current state is not ",(0,r.kt)("inlineCode",{parentName:"p"},"ReleasingDeposit"),", users can not withdraw from the contract."),(0,r.kt)("h3",{id:"oracle"},"Oracle"),(0,r.kt)("admonition",{title:"Intent",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Gain access to data stored outside of the blockchain.")),(0,r.kt)("p",null,"Blockchains have their own ecosystem and do not have access to data outside the blockchain network. Smart contracts can only import external data via a transaction. "),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Oracles")," solve this problem by connecting to the outside world. When an ",(0,r.kt)("inlineCode",{parentName:"p"},"oracle")," service and a smart contract communicate asynchronously, the ",(0,r.kt)("inlineCode",{parentName:"p"},"oracle")," service serves as an API. For example, there's a smart contract that has to fetch the current stock price of ",(0,r.kt)("inlineCode",{parentName:"p"},"Tesla"),", it has to talk with an Oracle, that fetches the stock price from real world."),(0,r.kt)("p",null,"Oracles are currently run by some trusted parties. This kinda breaks the decentralization.\ud83d\ude15"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},'// This code has not been professionally audited, therefore I cannot make any promises about\n// safety or correctness. Use at own risk.\nimport "github.com/oraclize/ethereum-api/oraclizeAPI.sol";\n\ncontract OracleExample is usingOraclize {\n\n    string public EURUSD;\n\n    function updatePrice() public payable {\n        if (oraclize_getPrice("URL") > this.balance) {\n            //Handle out of funds error\n        } else {\n            oraclize_query("URL", "json(http://api.fixer.io/latest?symbols=USD).rates.USD");\n        }\n    }\n    \n    function __callback(bytes32 myid, string result) public {\n        require(msg.sender == oraclize_cbAddress());\n        EURUSD = result;\n    }\n}\n')),(0,r.kt)("h3",{id:"randomness"},"Randomness"),(0,r.kt)("admonition",{title:"Intent",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Generate a random number of a predefined interval in the deterministic environment of a blockchain.")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The problem with randomness in Ethereum is that Ethereum is a deterministic Turing machine, with no inherent randomness involved."),(0,r.kt)("li",{parentName:"ul"},"A majority of miners have to obtain the same result when evaluating a transaction to reach consensus. ")),(0,r.kt)("h4",{id:"flaws"},"Flaws"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"One of the first sources of randomness in Ethereum that came to mind were block timestamps."),(0,r.kt)("li",{parentName:"ul"},"The problem with block timestamps is, that they can be influenced by the miner, as long as the timestamp is not older than its parent block. "),(0,r.kt)("li",{parentName:"ul"},"Block timestamps, block hashes, block numbers can all be either influenced or guessed.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},"// Randomness provided by this is predicatable. Use with care!\nfunction randomNumber() internal view returns (uint) {\n    return uint(blockhash(block.number - 1));\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"block.number is a variable available to everyone on the blockchain."),(0,r.kt)("li",{parentName:"ul"},"A user could use the ",(0,r.kt)("inlineCode",{parentName:"li"},"block.number")," as input.")),(0,r.kt)("h4",{id:"workarounds"},"Workarounds"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Block hash PRNG")," - the hash of a block as source of randomness"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Oracle RNG")," - randomness provided by an oracle, see Oracle pattern"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Collaborative PRNG")," - collaborative generation of a random number within the blockchain")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},"// This code has not been professionally audited, therefore I cannot make any promises about\n// safety or correctness. Use at own risk.\ncontract Randomness {\n\n    bytes32 sealedSeed;\n    bool seedSet = false;\n    bool betsClosed = false;\n    uint storedBlockNumber;\n\n    // a trused party hardcoded by the contract developer\n    address trustedParty = 0xdCad3a6d3569DF655070DEd06cb7A1b2Ccd1D3AF;\n\n    // The seed is set by the trusted party, and only by the trusted party, by calling `setSealedSeed(bytes32 _sealedSeed)`.\n    function setSealedSeed(bytes32 _sealedSeed) public {\n        require(!seedSet);\n        require (msg.sender == trustedParty);\n        betsClosed = true;\n        sealedSeed = _sealedSeed;\n        storedBlockNumber = block.number + 1;\n        seedSet = true;\n    }\n\n    //Users can make their bets by calling the function bet(). \n    function bet() public {\n        require(!betsClosed);\n        // Make bets here\n    }\n\n    function reveal(bytes32 _seed) public {\n        require(seedSet);\n        require(betMade);\n        require(storedBlockNumber < block.number);\n        require(keccak256(msg.sender, _seed) == sealedSeed);\n        uint random = uint(keccak256(_seed, blockhash(storedBlockNumber)));\n        // Insert logic for usage of random number here;\n        seedSet = false;\n        betsClosed = false;\n    }\n}\n")),(0,r.kt)("h2",{id:"security-patterns-1"},"Security patterns"),(0,r.kt)("h3",{id:"access-restriction"},"Access Restriction"),(0,r.kt)("admonition",{title:"Intent",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Restrict the access to contract functionality according to suitable criteria.")),(0,r.kt)("p",null,"Use the Access Restriction pattern when:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"your contract functions should only be callable under certain circumstances."),(0,r.kt)("li",{parentName:"ul"},"you want to apply similar restrictions to several functions."),(0,r.kt)("li",{parentName:"ul"},"you want to increase security of your smart contract against unauthorized access.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},"// This code has not been professionally audited, therefore I cannot make any promises about\n// safety or correctness. Use at own risk.\npragma solidity ^0.4.21;\n\ncontract AccessRestriction {\n\n    address public owner = msg.sender;\n    uint public lastOwnerChange = now;\n    \n    modifier onlyBy(address _account) {\n        require(msg.sender == _account);\n        _;\n    }\n    \n    modifier onlyAfter(uint _time) {\n        require(now >= _time);\n        _;\n    }\n    \n    modifier costs(uint _amount) {\n        require(msg.value >= _amount);\n        _;\n        if (msg.value > _amount) {\n            msg.sender.transfer(msg.value - _amount);\n        }\n    }\n    \n    function changeOwner(address _newOwner) public onlyBy(owner) {\n        owner = _newOwner;\n    }\n    \n    function buyContract() public payable onlyAfter(lastOwnerChange + 4 weeks) costs(1 ether) {\n        owner = msg.sender;\n        lastOwnerChange = now;\n    }\n}\n")),(0,r.kt)("h3",{id:"checks-effects-interactions"},"Checks Effects Interactions"),(0,r.kt)("admonition",{title:"Intent",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Reduce the attack surface for malicious contracts trying to hijack control flow after an external call.")),(0,r.kt)("p",null,"A possible attack vector is a re-entrancy attack, in which the malicious contract is reentering the initial contract, before the first instance of the function containing the call is finished. "),(0,r.kt)("p",null,"Use the Checks Effects Interactions pattern when:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"it cannot be avoided to hand over control flow to an external entity."),(0,r.kt)("li",{parentName:"ul"},"you want to guard your functions against re-entrancy attacks.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},"// This code has not been professionally audited, therefore I cannot make any promises about\n// safety or correctness. Use at own risk.\ncontract ChecksEffectsInteractions {\n\n    mapping(address => uint) balances;\n\n    function deposit() public payable {\n        balances[msg.sender] = msg.value;\n    }\n\n    function withdraw(uint amount) public {\n        require(balances[msg.sender] >= amount);\n\n        balances[msg.sender] -= amount;\n\n        msg.sender.transfer(amount);\n    }\n}\n")),(0,r.kt)("h3",{id:"secure-ether-transfer"},"Secure Ether Transfer"),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Secure transfer of ether from a contract to another address.")),(0,r.kt)("p",null,"Use the Secure Ether Transfer pattern when:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"you want to transfer ether from a contract address to another address in a secure way."),(0,r.kt)("li",{parentName:"ul"},"you are not sure which method of ether transfer is the most suitable for your needs."),(0,r.kt)("li",{parentName:"ul"},"you want to guard your contract against re-entrancy attacks.")),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Funtion"),(0,r.kt)("th",{parentName:"tr",align:null},"Amount of Gas Forwarded"),(0,r.kt)("th",{parentName:"tr",align:null},"Exception Propagation"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"send"),(0,r.kt)("td",{parentName:"tr",align:null},"2300 (not adjustable)"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"false")," on failure")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"call.value"),(0,r.kt)("td",{parentName:"tr",align:null},"all remaining gas (adjustable)"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"false")," on failure")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"transfer"),(0,r.kt)("td",{parentName:"tr",align:null},"2300 (not adjustable)"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"throws")," on failure")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},"// This code has not been professionally audited, therefore I cannot make any promises about\n// safety or correctness. Use at own risk.\ncontract EtherReceiver {\n    function () public payable {}\n}\n\ncontract EtherSender {\n\n    EtherReceiver private receiverAdr = new EtherReceiver();\n\n    function sendEther(uint _amount) public payable {\n        //transfer forwards exactly 2,300 gas\n        if (!address(receiverAdr).send(_amount)) {\n            //handle failed send\n        }\n    }\n\n    function callValueEther(uint _amount) public payable {\n        // for call() the return value needs to be verified\n        require(address(receiverAdr).call.value(_amount).gas(35000)());\n    }\n\n    function transferEther(uint _amount) public payable {\n       //transfer forwards exactly 2,300 gas\n        address(receiverAdr).transfer(_amount);\n    }\n}\n")),(0,r.kt)("h3",{id:"pull-over-push"},"Pull over Push:"),(0,r.kt)("admonition",{title:"Intent",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Shift the risk associated with transferring ether to the user.")),(0,r.kt)("admonition",{type:"danger"},(0,r.kt)("p",{parentName:"admonition"},"Never trust external calls to execute without throwing an error.")),(0,r.kt)("p",null,"Use the Pull over Push pattern when:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"you want to handle multiple ether transfers with one function call."),(0,r.kt)("li",{parentName:"ul"},"you want to avoid taking the risk associated with ether transfers."),(0,r.kt)("li",{parentName:"ul"},"there is an incentive for your users to handle ether withdrawal on their own.")),(0,r.kt)("h4",{id:"problem"},"Problem"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},"// THis code contains deliberate errors. Do not use.\ncontract BadAuction {\n\n    address highestBidder;\n    uint highestBid;\n\n    function bid() public payable {\n        require(msg.value >= highestBid);\n\n        if (highestBidder != 0) {\n            // if highestBidder is a contract; the fallback function gets triggered on transfer\n            // What if the fallback function of highestBidder just `reverts`?\n            highestBidder.transfer(highestBid); \n        }\n\n        highestBidder = msg.sender;\n        highestBid = msg.value;\n    }\n}\n")),(0,r.kt)("h4",{id:"possible-solution"},"Possible Solution"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},"// This code has not been professionally audited, therefore I cannot make any promises about\n// safety or correctness. Use at own risk.\ncontract PullOverPush {\n\n    uint highestBid;\n    address highestBidder;\n    mapping(address => uint) bids;\n\n    function bid() public payable {\n        require(msg.value >= highestBid);\n        bids[msg.sender] = msg.value;\n        highestBidder = msg.sender;\n    }\n\n    function withdrawBids() public {\n        require(msg.sender != highestBidder);\n\n        uint amount = credits[msg.sender];\n\n        require(amount != 0);\n        require(address(this).balance >= amount);\n\n        credits[msg.sender] = 0;\n\n        msg.sender.transfer(amount);\n    }\n}\n")),(0,r.kt)("h3",{id:"emergency-stop"},"Emergency Stop"),(0,r.kt)("admonition",{title:"Intent",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Add an option to disable critical contract functionality in case of an emergency.")),(0,r.kt)("p",null,"Use the Emergency Stop pattern when:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"you want to have the ability to pause your contract."),(0,r.kt)("li",{parentName:"ul"},"you want to guard critical functionality against the abuse of undiscovered bugs."),(0,r.kt)("li",{parentName:"ul"},"you want to prepare your contract for potential failures.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},"contract EmergencyStop {\n\n    bool isStopped = false;\n\n    modifier stoppedInEmergency {\n        require(!isStopped);\n        _;\n    }\n\n    modifier onlyWhenStopped {\n        require(isStopped);\n        _;\n    }\n\n    modifier onlyAuthorized {\n        // Check for authorization of msg.sender here\n        _;\n    }\n\n    function stopContract() public onlyAuthorized {\n        isStopped = true;\n    }\n\n    function resumeContract() public onlyAuthorized {\n        isStopped = false;\n    }\n\n    function deposit() public payable stoppedInEmergency {\n        // Deposit logic happening here\n    }\n\n    function emergencyWithdraw() public onlyWhenStopped {\n        // Emergency withdraw happening here\n    }\n}\n")),(0,r.kt)("h2",{id:"upgradeability-patterns-1"},"Upgradeability Patterns"),(0,r.kt)("h3",{id:"proxy-delegate"},"Proxy Delegate:"),(0,r.kt)("admonition",{title:"Intent",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Introduce the possibility to upgrade smart contracts without breaking any dependencies.")),(0,r.kt)("p",null,"Use the Proxy Delegate pattern when:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"you want to delegate function calls to other contracts."),(0,r.kt)("li",{parentName:"ul"},"you need upgradeable delegates, without breaking dependencies."),(0,r.kt)("li",{parentName:"ul"},"you are familiar with advanced concepts like delegatecalls and inline assembly.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},"contract Proxy {\n\n    address delegate;\n    address owner = msg.sender;\n\n    function upgradeDelegate(address newDelegateAddress) public {\n        require(msg.sender == owner);\n        delegate = newDelegateAddress;\n    }\n\n    function() external payable {\n        assembly {\n            let _target := sload(0)\n            calldatacopy(0x0, 0x0, calldatasize)\n            let result := delegatecall(gas, _target, 0x0, calldatasize, 0x0, 0)\n            returndatacopy(0x0, 0x0, returndatasize)\n            switch result case 0 {revert(0, 0)} default {return (0, returndatasize)}\n        }\n    }\n}\n")),(0,r.kt)("h3",{id:"eternal-storage"},"Eternal Storage"),(0,r.kt)("admonition",{title:"Intent",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Keep contract storage after a smart contract upgrade.")),(0,r.kt)("p",null,"Use the Eternal Storage pattern when:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"your contract is upgradeable and should retain storage after an upgrade."),(0,r.kt)("li",{parentName:"ul"},"you want to avoid problems with migrating storage after a contract upgrade."),(0,r.kt)("li",{parentName:"ul"},"you can accept a slightly more complex syntax for storing data.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},"contract EternalStorage {\n\n    address owner = msg.sender;\n    address latestVersion;\n\n    mapping(bytes32 => uint) uIntStorage;\n    mapping(bytes32 => address) addressStorage;\n\n    modifier onlyLatestVersion() {\n       require(msg.sender == latestVersion);\n        _;\n    }\n\n    function upgradeVersion(address _newVersion) public {\n        require(msg.sender == owner);\n        latestVersion = _newVersion;\n    }\n\n    // *** Getter Methods ***\n    function getUint(bytes32 _key) external view returns(uint) {\n        return uIntStorage[_key];\n    }\n\n    function getAddress(bytes32 _key) external view returns(address) {\n        return addressStorage[_key];\n    }\n\n    // *** Setter Methods ***\n    function setUint(bytes32 _key, uint _value) onlyLatestVersion external {\n        uIntStorage[_key] = _value;\n    }\n\n    function setAddress(bytes32 _key, address _value) onlyLatestVersion external {\n        addressStorage[_key] = _value;\n    }\n\n    // *** Delete Methods ***\n    function deleteUint(bytes32 _key) onlyLatestVersion external {\n        delete uIntStorage[_key];\n    }\n\n    function deleteAddress(bytes32 _key) onlyLatestVersion external {\n        delete addressStorage[_key];\n    }\n}\n")),(0,r.kt)("h2",{id:"memory-array-building"},"Memory Array Building"),(0,r.kt)("admonition",{title:"intent",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Aggregate and retrieve data from contract storage in a gas efficient way.")),(0,r.kt)("p",null,"Use the Memory Array Building pattern when:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"you want to retrieve aggregated data from storage."),(0,r.kt)("li",{parentName:"ul"},"you want to avoid paying gas when retrieving data."),(0,r.kt)("li",{parentName:"ul"},"your data has attributes that are subject to changes.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"showLineNumbers",showLineNumbers:!0},"contract MemoryArrayBuilding {\n\n    struct Item {\n        string name;\n        string category;\n        address owner;\n        uint32 zipcode;\n        uint32 price;\n    }\n\n    Item[] public items;\n\n    mapping(address => uint) public ownerItemCount;\n\n    function getItemIDsByOwner(address _owner) public view returns (uint[]) {\n        uint[] memory result = new uint[](ownerItemCount[_owner]);\n        uint counter = 0;\n        \n        for (uint i = 0; i < items.length; i++) {\n            if (items[i].owner == _owner) {\n                result[counter] = i;\n                counter++;\n            }\n        }\n        return result;\n    }\n}\n")),(0,r.kt)("h2",{id:"references"},"References"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/fravoll/solidity-patterns"},"https://github.com/fravoll/solidity-patterns")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://hackernoon.com/solidity-tutorial-understanding-design-patterns-part-1"},"https://hackernoon.com/solidity-tutorial-understanding-design-patterns-part-1")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://blog.quillhash.com/2022/04/22/smart-contract-security-an-agile-sdlc-approach/"},"https://blog.quillhash.com/2022/04/22/smart-contract-security-an-agile-sdlc-approach/")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://blog.logrocket.com/developers-guide-solidity-design-patterns/"},"https://blog.logrocket.com/developers-guide-solidity-design-patterns/")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://fravoll.github.io/solidity-patterns/"},"https://fravoll.github.io/solidity-patterns/")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://consensys.github.io/smart-contract-best-practices/development-recommendations/general/external-calls/#dont-use-transfer-or-send"},"https://consensys.github.io/smart-contract-best-practices/development-recommendations/general/external-calls/#dont-use-transfer-or-send")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/"},"https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://blog.trailofbits.com/2020/10/30/good-idea-bad-design-how-the-diamond-standard-falls-short/"},"https://blog.trailofbits.com/2020/10/30/good-idea-bad-design-how-the-diamond-standard-falls-short/")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://research.csiro.au/blockchainpatterns/general-patterns/security-patterns/"},"https://research.csiro.au/blockchainpatterns/general-patterns/security-patterns/")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://docs.openzeppelin.com/learn/"},"https://docs.openzeppelin.com/learn/"))))}d.isMDXComponent=!0},2526:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/quillhash-lifecycle-aada62b223a3cc163a989c7a81ea5db9.gif"}}]);